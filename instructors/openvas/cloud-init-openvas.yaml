#cloud-config
package_update: true
package_upgrade: true

users:
  - default
  - name: ita
    shell: /bin/bash
    groups: [docker, sudo]

write_files:
  - path: /etc/systemd/system/openvas.service
    owner: root:root
    permissions: '0644'
    content: |
      [Unit]
      Description=OpenVAS Docker Compose
      Requires=docker.service
      After=docker.service

      [Service]
      Type=oneshot
      WorkingDirectory=/greenbone-community-container
      ExecStart=/usr/bin/docker compose up -d
      ExecStop=/usr/bin/docker compose down
      RemainAfterExit=yes

      [Install]
      WantedBy=multi-user.target

runcmd:
  # Ensure target directory exists
  - mkdir -p /greenbone-community-container

  # Install dependencies
  - apt-get install -y ca-certificates curl gnupg

  # Remove conflicting Docker packages
  - |
    for pkg in docker.io docker-doc docker-compose podman-docker containerd runc; do
      apt-get remove -y $pkg || true
    done

  # Set up Docker repository
  - install -m 0755 -d /etc/apt/keyrings
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
  - chmod a+r /etc/apt/keyrings/docker.gpg
  - >
    sh -c 'echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg]
    https://download.docker.com/linux/ubuntu
    $(. /etc/os-release && echo "$VERSION_CODENAME") stable" > /etc/apt/sources.list.d/docker.list'

  - apt-get update

  # Install official Docker packages
  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin

  # Add 'ita' user to docker group
  - usermod -aG docker ita

  # Download and run setup script
  - curl -f -O https://greenbone.github.io/docs/latest/_static/setup-and-start-greenbone-community-edition.sh
  - chmod +x setup-and-start-greenbone-community-edition.sh
  - ./setup-and-start-greenbone-community-edition.sh

  # Fix docker-compose binding
  - sed -i 's/127.0.0.1:9392/0.0.0.0:9392/' /greenbone-community-container/docker-compose.yml

  # Reload systemd and enable service
  - systemctl daemon-reexec
  - systemctl daemon-reload
  - systemctl enable openvas.service
  - systemctl start openvas.service

 # Set admin password
  - docker compose -f /greenbone-community-container/docker-compose.yml exec -u gvmd gvmd gvmd --user=admin --new-password="820openvas"
